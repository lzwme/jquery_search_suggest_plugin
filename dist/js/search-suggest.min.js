/*
jquery_search_suggest_plugin - v0.1.0
Description: 这是一个基于 jQuery 的搜索建议插件。
Author: renxia <lzwy0820@qq.com>
Github: https://github.com/lzwme/jquery_search_suggest_plugin
Update: 2016-06-22 12:35:14
*/
!function(a){a.fn.searchSuggest=function(a){return"string"==typeof a&&b[a]?b[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?void 0:b.init.apply(this,arguments)};var b={init:function(b){var c=function(a){d("url错误或超时，请求失败!")},d=function(a){},e=function(a,b,c,d){for(var e=b.data||b,f='<div class="content">',h=0;h<e.length;h+=1)f+=d.tpl.replace(/\{([a-z]+)\}/gi,function(a,b){return e[h][b]});f+='</div><div class="description">'+d.json.defaults+"</div>",g(a,f,c,d)},f=function(b,c){var b=b||q,c=c||o;if(!a.trim(b.html()))return void b.hide();var d=b.find(".description");if("list"===c.style)return d.hide(),b.find(".content").css({width:"100%",border:"0"}),b.find(".content .list .word").css({width:"49%"}),void b.find(".desc").show();if("line"===c.style)return d.hide(),b.find(".desc").hide(),void b.find(".content").css({width:"100%",border:"0"});var e=b.find("."+c.listHoverCSS);if(e.length>0)var f=e.find(".word").attr("rel_id").split("_"),g=f[f.length-1],h=c.json.data[g].description;else var h=c.json.defaults;d.html(h)},g=function(b,c,d,e){var d=d||q,e=e||o;d.append(c),f(d,e),d.find(".list").each(function(){a(this).unbind("mouseover").mouseover(function(){h(d,e),a(this).addClass(e.listHoverCSS),f(d,e)}).unbind("click").click(function(){var c;e.multiWord?(c=b.val().split(" "),c[c.length-1]=i(a(this)),b.val(c.join(" "))):b.val(i(a(this))),b.focus()})})},h=function(a,b){var a=a||q,b=b||o;a.find("."+b.listHoverCSS).removeClass(b.listHoverCSS),f(a,b)},i=function(a){return a.find("div:first").text()},j=function(a,b,c,d){var f,g,h,i,c=c||q,d=d||o;return b=validData=l(b),validData&&b.data.length?(f=a.offset().left,g=a.height(),h=a.offset().top+d.topoffset+g,i=d.width||a.width()+"px",c.empty(),c.css({left:f,top:h,width:i}),e(a,b,c,d),a.focus(),void c.fadeIn(500)):(c.hide(),!1)},k=function(b,d,e,f,g){var h,i,f=f||q,g=g||o;if(g.url){var j=g.url.indexOf("?")>-1?"&":"?",k=g.jsonp?[g.url+b,j,g.jsonp,"=?"].join(""):g.url+b;a.ajax({type:"GET",url:k,dataType:"json",timeout:3e3,success:function(a){e(d,a,f,g)},error:c})}else{if(h=g.json,i=m(h),i&&a.trim(b)){for(var l="{'data':[",n=h.data.length-1;n>=0;n--)(h.data[n].word.indexOf(b)>-1||b.indexOf(h.data[n].word)>-1)&&(l+="{'id':'"+h.data[n].id+"','word':'"+h.data[n].word+"', 'description': '"+h.data[n].description+"'},");l+="],'defaults':'"+h.defaults+"'}",h=new Function("return "+l)()}e(d,h,f,g)}},l=function(a){return validData=m(a)},m=function(b){var c=!a.isArray(b.data);return c?(d("返回数据格式错误!"),!1):b.data.length?b:(d("返回数据为空!"),!1)},n=function(a){if(a){for(var b=document.getElementsByTagName("link"),c=b.length-1;c>=0;c--)if(b[c].href.indexOf(a)>-1)return;var d=document.createElement("link");d.setAttribute("rel","stylesheet"),d.setAttribute("type","text/css"),d.setAttribute("href",a),document.getElementsByTagName("head")[0].appendChild(d)}},o=a.extend({url:"",jsonp:null,json:{data:[{id:"0",word:"lzw.me",description:"http://lzw.me"}],defaults:"http://lzw.me"},style:"default",cssFile:"",dropDivClassName:"search-suggest",listHoverCSS:"jhover",tpl:'<div class="list"><div class="word" rel_id="st_{id}">{word}</div><div class="desc">{description}</div></div>',multiWord:!1,processData:l,getData:k,topoffset:6,keyLeft:37,keyUp:38,keyRight:39,keyDown:40,keyEnter:13},b);o.json.defaults=o.json.defaults||"",a.isFunction(o.processData)&&(l=o.processData),a.isFunction(o.getData)&&(k=o.getData);var p=this.data("searchsuggest");if(p)return this;this.data("searchsuggest",{target:this,options:o}),n(o.cssFile);var q=a('<div class="'+o.dropDivClassName+'"></div>').appendTo("body"),r=!1;return q.hover(function(){r=!0},function(){r=!1}),this.each(function(){var c=a(this);c.bind("keydown",function(d){if("none"!==q.css("display")){var e=q.find("."+o.listHoverCSS),f="";if(d.keyCode===o.keyDown?e.length?e.next().length?(h(q,o),e.next().length&&(f=i(e.next().mouseover()))):(h(q,o),c.val(c.attr("alt"))):f=i(q.find(".list:first").mouseover()):d.keyCode===o.keyUp?e.length?e.prev().length?(h(q,o),e.prev().length&&(f=i(e.prev().mouseover()))):(h(q,o),c.val(c.attr("alt"))):f=i(q.find(".list:last").mouseover()):d.keyCode===o.keyEnter&&q.empty().hide(),f){if(b.multiWord){var g=c.val(),j=g.split(" ");j[j.length-1]=f,c.val(j.join(" "))}else c.val(f);return!1}}c.attr("alt",a.trim(c.val()))}).bind("keyup",function(d){var e,f;d.keyCode!==o.keyDown&&d.keyCode!==o.keyUp&&(e=a.trim(c.val()),e&&e===c.attr("alt")||(b.multiWord&&(f=e.split(" "),e=f[f.length-1]),k(a.trim(e),c,j,q,o)))}).bind("blur",function(){r&&q.find("."+o.listHoverCSS).length||q.empty().hide()}).bind("click",function(){var d,e;d=c.val(),a.trim(d)&&d===c.attr("alt")||"none"!==q.css("display")||(b.multiWord&&(e=d.split(" "),d=e[e.length-1]),k(a.trim(d),c,j,q,o))})})},show:function(){var b=this.data("searchsuggest");return b&&b.options&&a("."+b.options.dropDivClassName).show(),this},hide:function(){var b=this.data("searchsuggest");return b&&b.options&&a("."+b.options.dropDivClassName).hide(),this},destroy:function(){var b=this.data("searchsuggest");return b&&b.options&&a("."+b.options.dropDivClassName).remove(),this.each(function(){a(this).unbind()})}}}(jQuery);